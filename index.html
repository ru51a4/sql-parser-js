<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>sql</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        .alias {
            color: blue;
            font-weight: bold;
        }

        .operator {
            color: red;
        }
    </style>
    <script src='index.js'></script>
</head>

<body>
    <div class="container">

        <div class="row mt-5">
            <div class="col-6">
                <textarea id="sql" class="form-control" rows="20" aria-label="scss">
SELECT * FROM diaries a JOIN
(SELECT diary_id as di, MAX(id) as kek FROM posts p group by diary_id ) gg ON a.id = gg.di
ORDER BY gg.kek desc</textarea>
            </div>
            <div class="main col-6">
            </div>
        </div>
        <div class="row error mt-5 d-flex justify-content-center">
        </div>
    </div>
</body>
<script>
    let sql = document.querySelector('#sql');
    let main = document.querySelector('.main');
    let mainfn = () => {
        let obj = getObject(`( ${sql.value} )`);
        console.log({ obj })
        let getHtml = (obj, init = false) => {
            let html = "<br>";

            if (typeof obj === 'string') {
                return obj
            }
            if (!init) {
                html += ' ( ';
            }
            html += '<span class="operator">SELECT </span>';
            html += obj.columns.reduce((acc, c, i) => acc + `<span>${getHtml(c.col)}</span>${c.alias ? ` AS ${c.alias}` : ''}${obj.columns.length - 1 === i ? '' : `<span>, </span>`}`, '');
            html += `<span class="operator"><br> FROM </span>`;
            html += `<span>${getHtml(obj.fromSources[0].table)}</span>  <span class="alias">${obj.fromSources[0]?.alias ?? ''} </span>`
            html += obj.joins.reduce((acc, c) => {
                return acc + `<span class="operator"><br>${c.type ?? ''} JOIN </span> ` + getHtml(c.table) + '' + ` <span class="alias">${c.alias}</span> ` + c.exp?.reduce((acc, c) => {
                    return acc + `<span class="operator"> ${c.ttype}</span> <span>${getHtml(c.left)}</span> <span class="${c.type === "IN" ? 'operator' : ''}">${c.type}</span> <span>${getHtml(c.right)}</span>`
                }, '')
            }, '');
            html += (!obj.whereClauses.length) ? '' : `<span  class="operator"><br>WHERE</span>`;
            html += obj.whereClauses.reduce((acc, c) => acc + `<span> ${getHtml(c.left)}</span> <span class="operator">${c.type}</span> <span>${getHtml(c.right)}</span> <span class="operator">${c.next != undefined ? c.next : ''}</span>  `, '');
            html += (!obj.groupByColumns.length) ? '' : `<span class="operator"><br>GROUP BY</span>`;
            html += obj.groupByColumns.reduce((acc, c) => acc + `<span> ${c.col}</span>`, '');

            html += (!obj.sortColumns.length) ? '' : `<span class="operator"><br>ORDER BY</span>`;
            html += obj.sortColumns.reduce((acc, c) => acc + `<span> ${c.col}</span> <span>${c.type}</span>`, '');
            html += obj.limit.reduce((acc, c) => acc + `<span> ${c.type.toUpperCase()}</span> <span>${c.col}</span>`, '');


            if (!init) {
                html += ' ) ';
            }
            return html
        }
        main.innerHTML = getHtml(obj[0], 1)
        document.querySelector('.error').innerHTML = `<div class="alert alert-success d-flex align-items-center" role="alert">
                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Success:"><use xlink:href="#check-circle-fill"/></svg>
                <div>
                    sql valid
                </div>
                </div>
                                `;
    }
    sql.addEventListener('keyup', () => {

        try {
            mainfn();
        } catch (e) {
            main.innerHTML = ''
            document.querySelector('.error').innerHTML = `
                <div class="alert alert-danger d-flex align-items-center" role="alert">
                <svg class="bi flex-shrink-0 me-2" width="24" height="24" role="img" aria-label="Danger:"><use xlink:href="#exclamation-triangle-fill"/></svg>
                <div>
                    ${e}
                </div>
                </div>
                `;

        }
    }, false);
    document.addEventListener("DOMContentLoaded", mainfn());


</script>

</html>